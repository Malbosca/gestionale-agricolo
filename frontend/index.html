<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üå± Gestionale Agricolo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    [x-cloak] { display: none !important; }
  </style>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div x-data="app()" x-init="init()">
    <!-- Header -->
    <header class="bg-green-600 text-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex items-center gap-3">
          <i data-lucide="leaf" class="w-8 h-8"></i>
          <div>
            <h1 class="text-xl font-bold">Gestionale Agricolo</h1>
            <p class="text-green-100 text-sm">Tracciabilit√† e Lavorazioni</p>
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-6">
      <!-- Tabs -->
      <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
        <template x-for="tab in tabs" :key="tab.id">
          <button 
            @click="activeTab = tab.id"
            :class="activeTab === tab.id 
              ? 'bg-green-600 text-white' 
              : 'bg-white text-gray-600 hover:bg-gray-100'"
            class="flex items-center gap-2 px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors"
          >
            <i :data-lucide="tab.icon" class="w-4 h-4"></i>
            <span x-text="tab.label"></span>
          </button>
        </template>
      </div>

      <!-- Loading -->
      <div x-show="loading" class="flex items-center justify-center py-20">
        <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-green-600"></i>
      </div>

      <!-- Dashboard -->
      <div x-show="activeTab === 'dashboard' && !loading" x-cloak>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-white rounded-xl shadow-sm border p-4">
            <div class="flex items-center gap-3">
              <div class="p-2 rounded-lg bg-blue-500">
                <i data-lucide="package" class="w-5 h-5 text-white"></i>
              </div>
              <div>
                <p class="text-sm text-gray-500">Prodotti</p>
                <p class="text-xl font-semibold" x-text="products.length"></p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border p-4">
            <div class="flex items-center gap-3">
              <div class="p-2 rounded-lg bg-green-500">
                <i data-lucide="leaf" class="w-5 h-5 text-white"></i>
              </div>
              <div>
                <p class="text-sm text-gray-500">Lotti in giacenza</p>
                <p class="text-xl font-semibold" x-text="batches.length"></p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border p-4">
            <div class="flex items-center gap-3">
              <div class="p-2 rounded-lg bg-amber-500">
                <i data-lucide="bar-chart-3" class="w-5 h-5 text-white"></i>
              </div>
              <div>
                <p class="text-sm text-gray-500">Raccolto (30gg)</p>
                <p class="text-xl font-semibold" x-text="(dashboard?.monthly_harvest_kg || 0) + ' kg'"></p>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border">
          <div class="p-4 border-b">
            <h2 class="font-semibold">Ultime Operazioni</h2>
          </div>
          <div class="divide-y">
            <template x-for="op in dashboard?.recent_operations || []" :key="op.id">
              <div class="p-4 flex items-center justify-between">
                <div>
                  <p class="font-medium" x-text="op.type_name"></p>
                  <p class="text-sm text-gray-500" x-text="op.plot_name || 'Nessun appezzamento'"></p>
                </div>
                <span class="text-sm text-gray-500" x-text="op.operation_date"></span>
              </div>
            </template>
            <div x-show="!dashboard?.recent_operations?.length" class="p-4 text-gray-500 text-center">
              Nessuna operazione registrata
            </div>
          </div>
        </div>
      </div>

      <!-- Prodotti -->
      <div x-show="activeTab === 'products' && !loading" x-cloak>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">Prodotti</h2>
          <button @click="showProductModal = true" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
            <i data-lucide="plus" class="w-4 h-4"></i> Nuovo Prodotto
          </button>
        </div>
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">SKU</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Nome</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Categoria</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-for="p in products" :key="p.id">
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3 font-mono text-sm" x-text="p.sku"></td>
                  <td class="px-4 py-3" x-text="p.name"></td>
                  <td class="px-4 py-3 text-gray-500" x-text="p.category_name"></td>
                </tr>
              </template>
            </tbody>
          </table>
          <div x-show="!products.length" class="p-8 text-center text-gray-500">
            Nessun prodotto. Crea il primo!
          </div>
        </div>
      </div>

      <!-- Lotti -->
      <div x-show="activeTab === 'batches' && !loading" x-cloak>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">Lotti in Giacenza</h2>
          <button @click="showBatchModal = true" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
            <i data-lucide="plus" class="w-4 h-4"></i> Nuovo Acquisto
          </button>
        </div>
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Lotto</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Prodotto</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">SKU</th>
                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">Giacenza</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-for="b in batches" :key="b.id">
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3 font-mono text-sm" x-text="b.batch_code"></td>
                  <td class="px-4 py-3" x-text="b.product_name"></td>
                  <td class="px-4 py-3 text-gray-500" x-text="b.sku"></td>
                  <td class="px-4 py-3 text-right font-medium" x-text="b.current_qty + ' ' + (b.unit_code || '')"></td>
                </tr>
              </template>
            </tbody>
          </table>
          <div x-show="!batches.length" class="p-8 text-center text-gray-500">
            Nessun lotto in giacenza
          </div>
        </div>
      </div>

      <!-- Appezzamenti -->
      <div x-show="activeTab === 'plots' && !loading" x-cloak>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">Appezzamenti</h2>
          <button @click="showPlotModal = true" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
            <i data-lucide="plus" class="w-4 h-4"></i> Nuovo Appezzamento
          </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <template x-for="p in plots" :key="p.id">
            <div class="bg-white rounded-xl shadow-sm border p-4">
              <div class="flex items-start gap-3">
                <div class="p-2 bg-green-100 rounded-lg">
                  <i data-lucide="map-pin" class="w-5 h-5 text-green-600"></i>
                </div>
                <div>
                  <h3 class="font-semibold" x-text="p.name"></h3>
                  <p class="text-sm text-gray-500" x-text="'Codice: ' + p.code"></p>
                  <p x-show="p.area_sqm" class="text-sm text-gray-500" x-text="p.area_sqm + ' m¬≤'"></p>
                </div>
              </div>
            </div>
          </template>
        </div>
        <div x-show="!plots.length" class="bg-white rounded-xl shadow-sm border p-8 text-center text-gray-500">
          Nessun appezzamento. Crea il primo!
        </div>
      </div>

      <!-- Operazioni -->
      <div x-show="activeTab === 'operations' && !loading" x-cloak>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">Operazioni</h2>
          <button @click="showOperationModal = true" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
            <i data-lucide="plus" class="w-4 h-4"></i> Nuova Operazione
          </button>
        </div>
        <div class="bg-white rounded-xl shadow-sm border">
          <div class="divide-y">
            <template x-for="op in operations" :key="op.id">
              <div class="p-4 flex items-center justify-between hover:bg-gray-50">
                <div class="flex items-center gap-4">
                  <div class="p-2 bg-amber-100 rounded-lg">
                    <i data-lucide="clipboard-list" class="w-5 h-5 text-amber-600"></i>
                  </div>
                  <div>
                    <p class="font-medium" x-text="op.type_name"></p>
                    <p class="text-sm text-gray-500" x-text="(op.plot_name || 'Nessun appezzamento') + (op.notes ? ' ‚Ä¢ ' + op.notes : '')"></p>
                  </div>
                </div>
                <span class="text-sm text-gray-500" x-text="op.operation_date"></span>
              </div>
            </template>
          </div>
          <div x-show="!operations.length" class="p-8 text-center text-gray-500">
            Nessuna operazione registrata
          </div>
        </div>
      </div>

      <!-- Fornitori -->
      <div x-show="activeTab === 'suppliers' && !loading" x-cloak>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">Fornitori</h2>
          <button @click="showSupplierModal = true" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
            <i data-lucide="plus" class="w-4 h-4"></i> Nuovo Fornitore
          </button>
        </div>
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Codice</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Ragione Sociale</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">P.IVA</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Citt√†</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Contatti</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-for="s in suppliers" :key="s.id">
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3 font-mono text-sm text-green-600" x-text="s.code"></td>
                  <td class="px-4 py-3 font-medium" x-text="s.name"></td>
                  <td class="px-4 py-3 text-gray-500 font-mono text-sm" x-text="s.vat_number || '-'"></td>
                  <td class="px-4 py-3 text-gray-500" x-text="s.city ? (s.city + (s.province ? ' (' + s.province + ')' : '')) : '-'"></td>
                  <td class="px-4 py-3 text-gray-500 text-sm">
                    <span x-show="s.phone" x-text="s.phone"></span>
                    <span x-show="s.phone && s.email"> ‚Ä¢ </span>
                    <span x-show="s.email" x-text="s.email"></span>
                    <span x-show="!s.phone && !s.email">-</span>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
          <div x-show="!suppliers.length" class="p-8 text-center text-gray-500">
            Nessun fornitore. Crea il primo!
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Nuovo Prodotto + Acquisto -->
    <div x-show="showProductModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl w-full max-w-lg max-h-[90vh] overflow-auto" @click.away="showProductModal = false">
        <div class="p-4 border-b flex justify-between items-center">
          <h2 class="text-lg font-semibold">Nuovo Prodotto + Acquisto</h2>
          <button @click="showProductModal = false" class="text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
        <form @submit.prevent="createProduct()" class="p-4">
          <div class="mb-3 p-3 bg-green-50 rounded-lg text-sm text-green-700">
            <i data-lucide="info" class="w-4 h-4 inline"></i>
            SKU e codice lotto generati automaticamente
          </div>
          
          <!-- SEZIONE PRODOTTO -->
          <div class="mb-4 pb-3 border-b">
            <h3 class="font-medium text-gray-700 mb-3">üì¶ Dati Prodotto</h3>
            <div class="grid grid-cols-2 gap-3">
              <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Categoria *</label>
                <select x-model="newProduct.category_id" required class="w-full px-3 py-2 border rounded-lg">
                  <option value="">Seleziona...</option>
                  <template x-for="c in categories" :key="c.id">
                    <option :value="c.id" x-text="c.name"></option>
                  </template>
                </select>
              </div>
              <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Nome Prodotto *</label>
                <input x-model="newProduct.name" type="text" placeholder="Es: Semi Pomodoro San Marzano" required class="w-full px-3 py-2 border rounded-lg">
              </div>
            </div>
          </div>
          
          <!-- SEZIONE FORNITORE -->
          <div class="mb-4 pb-3 border-b">
            <h3 class="font-medium text-gray-700 mb-3">üöö Fornitore</h3>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Fornitore *</label>
              <select x-model="newProduct.supplier_id" required class="w-full px-3 py-2 border rounded-lg">
                <option value="">Seleziona fornitore...</option>
                <template x-for="s in suppliers" :key="s.id">
                  <option :value="s.id" x-text="s.code + ' - ' + s.name"></option>
                </template>
              </select>
            </div>
          </div>
          
          <!-- SEZIONE DOCUMENTO -->
          <div class="mb-4 pb-3 border-b">
            <h3 class="font-medium text-gray-700 mb-3">üìÑ Documento Acquisto</h3>
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                <select x-model="newProduct.document_type" class="w-full px-3 py-2 border rounded-lg">
                  <option value="">-</option>
                  <option value="ddt">DDT</option>
                  <option value="fattura">Fattura</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Numero</label>
                <input x-model="newProduct.document_number" type="text" placeholder="N¬∞ doc" class="w-full px-3 py-2 border rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                <input x-model="newProduct.document_date" type="date" class="w-full px-3 py-2 border rounded-lg">
              </div>
            </div>
          </div>
          
          <!-- SEZIONE QUANTIT√Ä -->
          <div class="mb-4">
            <h3 class="font-medium text-gray-700 mb-3">üìä Quantit√† Acquistata</h3>
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Quantit√† *</label>
                <input x-model="newProduct.quantity" type="number" step="0.01" min="0.01" placeholder="10" required class="w-full px-3 py-2 border rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Formato *</label>
                <select x-model="newProduct.unit_id" required class="w-full px-3 py-2 border rounded-lg">
                  <option value="">Seleziona...</option>
                  <template x-for="u in units" :key="u.id">
                    <option :value="u.id" x-text="u.name + ' (' + u.symbol + ')'"></option>
                  </template>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Prezzo ‚Ç¨</label>
                <input x-model="newProduct.purchase_price" type="number" step="0.01" min="0" placeholder="0.00" class="w-full px-3 py-2 border rounded-lg">
              </div>
            </div>
          </div>
          
          <!-- Note -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
            <input x-model="newProduct.notes" type="text" placeholder="Note opzionali..." class="w-full px-3 py-2 border rounded-lg">
          </div>
          
          <button type="submit" :disabled="saving" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <span x-show="saving" class="animate-spin">‚è≥</span>
            <span x-text="saving ? 'Salvataggio...' : 'Salva Prodotto + Acquisto'"></span>
          </button>
        </form>
      </div>
    </div>

    <!-- Modal: Nuovo Lotto -->
    <div x-show="showBatchModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl w-full max-w-lg max-h-[90vh] overflow-auto" @click.away="showBatchModal = false">
        <div class="p-4 border-b flex justify-between items-center">
          <h2 class="text-lg font-semibold">Registra Acquisto</h2>
          <button @click="showBatchModal = false" class="text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
        <form @submit.prevent="createBatch()" class="p-4">
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Codice Lotto</label>
            <input x-model="newBatch.batch_code" type="text" placeholder="ES: LOTTO-2024-001" required class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Prodotto</label>
            <select x-model="newBatch.product_id" required class="w-full px-3 py-2 border rounded-lg">
              <option value="">Seleziona...</option>
              <template x-for="p in products" :key="p.id">
                <option :value="p.id" x-text="p.sku + ' - ' + p.name"></option>
              </template>
            </select>
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Fornitore</label>
            <select x-model="newBatch.supplier_id" class="w-full px-3 py-2 border rounded-lg">
              <option value="">Seleziona...</option>
              <template x-for="s in suppliers" :key="s.id">
                <option :value="s.id" x-text="s.name"></option>
              </template>
            </select>
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Quantit√†</label>
            <input x-model="newBatch.initial_qty" type="number" step="0.01" required class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Unit√†</label>
            <select x-model="newBatch.unit_id" class="w-full px-3 py-2 border rounded-lg">
              <option value="">Seleziona...</option>
              <template x-for="u in units" :key="u.id">
                <option :value="u.id" x-text="u.name + ' (' + u.code + ')'"></option>
              </template>
            </select>
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Data Acquisto</label>
            <input x-model="newBatch.purchase_date" type="date" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Prezzo ‚Ç¨</label>
            <input x-model="newBatch.purchase_price" type="number" step="0.01" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <button type="submit" :disabled="saving" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <span x-show="saving" class="animate-spin">‚è≥</span>
            <span x-text="saving ? 'Salvataggio...' : 'Registra Acquisto'"></span>
          </button>
        </form>
      </div>
    </div>

    <!-- Modal: Nuovo Appezzamento -->
    <div x-show="showPlotModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl w-full max-w-lg" @click.away="showPlotModal = false">
        <div class="p-4 border-b flex justify-between items-center">
          <h2 class="text-lg font-semibold">Nuovo Appezzamento</h2>
          <button @click="showPlotModal = false" class="text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
        <form @submit.prevent="createPlot()" class="p-4">
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Codice</label>
            <input x-model="newPlot.code" type="text" placeholder="ES: SERRA-01" required class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
            <input x-model="newPlot.name" type="text" placeholder="Es: Serra Grande" required class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Superficie (m¬≤)</label>
            <input x-model="newPlot.area_sqm" type="number" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
            <input x-model="newPlot.notes" type="text" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <button type="submit" :disabled="saving" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <span x-show="saving" class="animate-spin">‚è≥</span>
            <span x-text="saving ? 'Salvataggio...' : 'Salva Appezzamento'"></span>
          </button>
        </form>
      </div>
    </div>

    <!-- Modal: Nuovo Fornitore -->
    <div x-show="showSupplierModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl w-full max-w-lg max-h-[90vh] overflow-auto" @click.away="showSupplierModal = false">
        <div class="p-4 border-b flex justify-between items-center">
          <h2 class="text-lg font-semibold">Nuovo Fornitore</h2>
          <button @click="showSupplierModal = false" class="text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
        <form @submit.prevent="createSupplier()" class="p-4">
          <div class="mb-3 p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
            <i data-lucide="info" class="w-4 h-4 inline"></i>
            Il codice fornitore verr√† generato automaticamente
          </div>
          
          <!-- Ragione Sociale -->
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Ragione Sociale *</label>
            <input x-model="newSupplier.name" type="text" placeholder="Es: Sementi Italia Srl" required class="w-full px-3 py-2 border rounded-lg">
          </div>
          
          <!-- P.IVA -->
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Partita IVA</label>
            <input x-model="newSupplier.vat_number" type="text" placeholder="Es: IT01234567890" maxlength="16" class="w-full px-3 py-2 border rounded-lg font-mono">
          </div>
          
          <!-- Indirizzo -->
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Indirizzo</label>
            <input x-model="newSupplier.address" type="text" placeholder="Via/Piazza, numero civico" class="w-full px-3 py-2 border rounded-lg">
          </div>
          
          <!-- Citt√†, Provincia, CAP -->
          <div class="grid grid-cols-5 gap-2 mb-3">
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Citt√†</label>
              <input x-model="newSupplier.city" type="text" placeholder="Citt√†" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div class="col-span-1">
              <label class="block text-sm font-medium text-gray-700 mb-1">Prov.</label>
              <input x-model="newSupplier.province" type="text" placeholder="MI" maxlength="2" class="w-full px-3 py-2 border rounded-lg uppercase">
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">CAP</label>
              <input x-model="newSupplier.zip_code" type="text" placeholder="20100" maxlength="5" class="w-full px-3 py-2 border rounded-lg">
            </div>
          </div>
          
          <!-- Telefono e Email -->
          <div class="grid grid-cols-2 gap-2 mb-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Telefono</label>
              <input x-model="newSupplier.phone" type="tel" placeholder="+39 02 1234567" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input x-model="newSupplier.email" type="email" placeholder="info@esempio.it" class="w-full px-3 py-2 border rounded-lg">
            </div>
          </div>
          
          <!-- Note -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
            <textarea x-model="newSupplier.notes" rows="2" placeholder="Note aggiuntive..." class="w-full px-3 py-2 border rounded-lg"></textarea>
          </div>
          
          <button type="submit" :disabled="saving" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <span x-show="saving" class="animate-spin">‚è≥</span>
            <span x-text="saving ? 'Salvataggio...' : 'Salva Fornitore'"></span>
          </button>
        </form>
      </div>
    </div>

    <!-- Modal: Nuova Operazione -->
    <div x-show="showOperationModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl w-full max-w-lg max-h-[90vh] overflow-auto" @click.away="showOperationModal = false">
        <div class="p-4 border-b flex justify-between items-center">
          <h2 class="text-lg font-semibold">Nuova Operazione</h2>
          <button @click="showOperationModal = false" class="text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
        <form @submit.prevent="createOperation()" class="p-4">
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Operazione</label>
            <select x-model="newOperation.type_code" required class="w-full px-3 py-2 border rounded-lg">
              <option value="">Seleziona...</option>
              <template x-for="t in operationTypes" :key="t.id">
                <option :value="t.code" x-text="t.name"></option>
              </template>
            </select>
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
            <input x-model="newOperation.operation_date" type="date" required class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Appezzamento</label>
            <select x-model="newOperation.plot_id" class="w-full px-3 py-2 border rounded-lg">
              <option value="">Seleziona...</option>
              <template x-for="p in plots" :key="p.id">
                <option :value="p.id" x-text="p.name"></option>
              </template>
            </select>
          </div>
          <hr class="my-4">
          <p class="text-sm text-gray-500 mb-2">Materiale utilizzato (opzionale)</p>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Lotto</label>
            <select x-model="newOperation.batch_id" class="w-full px-3 py-2 border rounded-lg">
              <option value="">Seleziona...</option>
              <template x-for="b in batches" :key="b.id">
                <option :value="b.id" x-text="b.batch_code + ' - ' + b.product_name + ' (' + b.current_qty + ' ' + (b.unit_code || '') + ')'"></option>
              </template>
            </select>
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Quantit√† utilizzata</label>
            <input x-model="newOperation.quantity" type="number" step="0.01" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
            <input x-model="newOperation.notes" type="text" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <button type="submit" :disabled="saving" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <span x-show="saving" class="animate-spin">‚è≥</span>
            <span x-text="saving ? 'Salvataggio...' : 'Registra Operazione'"></span>
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://gestionale-agricolo-api.aziendamalbosca.workers.dev';

    function app() {
      return {
        activeTab: 'dashboard',
        loading: true,
        
        // Data
        products: [],
        batches: [],
        plots: [],
        operations: [],
        suppliers: [],
        categories: [],
        units: [],
        operationTypes: [],
        dashboard: null,

        // Modals
        showProductModal: false,
        showBatchModal: false,
        showPlotModal: false,
        showSupplierModal: false,
        showOperationModal: false,
        saving: false,

        // Forms
        newProduct: { 
          name: '', category_id: '', notes: '',
          supplier_id: '', document_type: '', document_number: '', document_date: '',
          quantity: '', unit_id: '', purchase_price: ''
        },
        newBatch: { batch_code: '', product_id: '', supplier_id: '', initial_qty: '', unit_id: '', purchase_date: '', purchase_price: '' },
        newPlot: { code: '', name: '', area_sqm: '', notes: '' },
        newSupplier: { name: '', vat_number: '', address: '', city: '', province: '', zip_code: '', phone: '', email: '', notes: '' },
        newOperation: { type_code: '', operation_date: '', plot_id: '', batch_id: '', quantity: '', notes: '' },

        tabs: [
          { id: 'dashboard', label: 'Dashboard', icon: 'bar-chart-3' },
          { id: 'products', label: 'Prodotti', icon: 'package' },
          { id: 'batches', label: 'Lotti', icon: 'leaf' },
          { id: 'plots', label: 'Appezzamenti', icon: 'map-pin' },
          { id: 'operations', label: 'Operazioni', icon: 'clipboard-list' },
          { id: 'suppliers', label: 'Fornitori', icon: 'truck' },
        ],

        async init() {
          await this.loadAll();
          lucide.createIcons();
          this.$watch('activeTab', () => setTimeout(() => lucide.createIcons(), 10));
        },

        async loadAll() {
          this.loading = true;
          try {
            const [products, batches, plots, operations, suppliers, categories, units, operationTypes, dashboard] = await Promise.all([
              this.fetch('/api/products'),
              this.fetch('/api/batches?with_stock=true'),
              this.fetch('/api/plots'),
              this.fetch('/api/operations'),
              this.fetch('/api/suppliers'),
              this.fetch('/api/categories'),
              this.fetch('/api/units'),
              this.fetch('/api/operation-types'),
              this.fetch('/api/dashboard'),
            ]);
            this.products = products;
            this.batches = batches;
            this.plots = plots;
            this.operations = operations;
            this.suppliers = suppliers;
            this.categories = categories;
            this.units = units;
            this.operationTypes = operationTypes;
            this.dashboard = dashboard;
          } catch (e) {
            console.error(e);
          }
          this.loading = false;
        },

        async fetch(endpoint) {
          const res = await fetch(API_BASE + endpoint);
          return res.json();
        },

        async post(endpoint, data) {
          const res = await fetch(API_BASE + endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          return res.json();
        },

        async createProduct() {
          if (this.saving) return;
          this.saving = true;
          try {
            await this.post('/api/products/with-purchase', this.newProduct);
            this.showProductModal = false;
            this.newProduct = { 
              name: '', category_id: '', notes: '',
              supplier_id: '', document_type: '', document_number: '', document_date: '',
              quantity: '', unit_id: '', purchase_price: ''
            };
            this.products = await this.fetch('/api/products');
            this.batches = await this.fetch('/api/batches?with_stock=true');
            this.dashboard = await this.fetch('/api/dashboard');
          } finally {
            this.saving = false;
          }
        },

        async createBatch() {
          if (this.saving) return;
          this.saving = true;
          try {
            await this.post('/api/batches', { ...this.newBatch, source_type: 'purchase' });
            this.showBatchModal = false;
            this.newBatch = { batch_code: '', product_id: '', supplier_id: '', initial_qty: '', unit_id: '', purchase_date: '', purchase_price: '' };
            this.batches = await this.fetch('/api/batches?with_stock=true');
          } finally {
            this.saving = false;
          }
        },

        async createPlot() {
          if (this.saving) return;
          this.saving = true;
          try {
            await this.post('/api/plots', this.newPlot);
            this.showPlotModal = false;
            this.newPlot = { code: '', name: '', area_sqm: '', notes: '' };
            this.plots = await this.fetch('/api/plots');
          } finally {
            this.saving = false;
          }
        },

        async createSupplier() {
          if (this.saving) return;
          this.saving = true;
          try {
            await this.post('/api/suppliers', this.newSupplier);
            this.showSupplierModal = false;
            this.newSupplier = { name: '', vat_number: '', address: '', city: '', province: '', zip_code: '', phone: '', email: '', notes: '' };
            this.suppliers = await this.fetch('/api/suppliers');
          } finally {
            this.saving = false;
          }
        },

        async createOperation() {
          if (this.saving) return;
          this.saving = true;
          try {
            const data = {
              type_code: this.newOperation.type_code,
              operation_date: this.newOperation.operation_date,
              plot_id: this.newOperation.plot_id || null,
              notes: this.newOperation.notes,
              movements: []
            };
            if (this.newOperation.batch_id && this.newOperation.quantity) {
              data.movements.push({
                batch_id: parseInt(this.newOperation.batch_id),
                movement_type: 'input',
                quantity: parseFloat(this.newOperation.quantity)
              });
            }
            await this.post('/api/operations', data);
            this.showOperationModal = false;
            this.newOperation = { type_code: '', operation_date: '', plot_id: '', batch_id: '', quantity: '', notes: '' };
            this.operations = await this.fetch('/api/operations');
            this.batches = await this.fetch('/api/batches?with_stock=true');
            this.dashboard = await this.fetch('/api/dashboard');
          } finally {
            this.saving = false;
          }
        }
      }
    }
  </script>
</body>
</html>
