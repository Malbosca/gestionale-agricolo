<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üå± Gestionale Agricolo</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Sistema di gestione per aziende agricole con tracciabilit√† completa">
  <meta name="theme-color" content="#16a34a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Agricolo">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- PWA Manifest & Icons -->
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    [x-cloak] { display: none !important; }
    /* PWA Install Banner */
    .install-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    /* iOS Safari notch support */
    @supports (padding: max(0px)) {
      .install-banner {
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
      }
      .safe-area-bottom {
        padding-bottom: env(safe-area-inset-bottom);
      }
    }
    /* Bottom nav spacing */
    @media (max-width: 1023px) {
      body {
        padding-bottom: 4rem;
      }
    }
  </style>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div x-data="app()" x-init="init()" class="flex min-h-screen">
    
    <!-- Sidebar Desktop -->
    <aside class="hidden lg:flex lg:flex-col lg:w-64 lg:fixed lg:inset-y-0 bg-white border-r shadow-sm z-40">
      <!-- Logo -->
      <div class="flex items-center gap-3 px-6 py-5 border-b bg-green-600 text-white">
        <i data-lucide="leaf" class="w-8 h-8"></i>
        <div>
          <h1 class="font-bold text-lg">Gestionale Agricolo</h1>
          <p class="text-green-100 text-xs">Tracciabilit√†</p>
        </div>
      </div>
      
      <!-- Menu Items -->
      <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
        <p class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Panoramica</p>
        <button @click="activeTab = 'dashboard'" 
          :class="activeTab === 'dashboard' ? 'bg-green-50 text-green-700 border-green-200' : 'text-gray-600 hover:bg-gray-50'"
          class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors border border-transparent">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
          <span>Dashboard</span>
        </button>
        
        <p class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider mt-6 mb-2">Magazzino</p>
        <button @click="activeTab = 'products'" 
          :class="activeTab === 'products' ? 'bg-green-50 text-green-700 border-green-200' : 'text-gray-600 hover:bg-gray-50'"
          class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors border border-transparent">
          <i data-lucide="package" class="w-5 h-5"></i>
          <span>Prodotti</span>
          <span class="ml-auto text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full" x-text="products.length"></span>
        </button>
        <button @click="activeTab = 'batches'" 
          :class="activeTab === 'batches' ? 'bg-green-50 text-green-700 border-green-200' : 'text-gray-600 hover:bg-gray-50'"
          class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors border border-transparent">
          <i data-lucide="layers" class="w-5 h-5"></i>
          <span>Lotti / Giacenze</span>
          <span class="ml-auto text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full" x-text="batches.length"></span>
        </button>
        <button @click="activeTab = 'suppliers'" 
          :class="activeTab === 'suppliers' ? 'bg-green-50 text-green-700 border-green-200' : 'text-gray-600 hover:bg-gray-50'"
          class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors border border-transparent">
          <i data-lucide="truck" class="w-5 h-5"></i>
          <span>Fornitori</span>
          <span class="ml-auto text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full" x-text="suppliers.length"></span>
        </button>
        
        <p class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider mt-6 mb-2">Coltivazione</p>
        <button @click="activeTab = 'plots'" 
          :class="activeTab === 'plots' ? 'bg-green-50 text-green-700 border-green-200' : 'text-gray-600 hover:bg-gray-50'"
          class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors border border-transparent">
          <i data-lucide="map-pin" class="w-5 h-5"></i>
          <span>Appezzamenti</span>
          <span class="ml-auto text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full" x-text="plots.length"></span>
        </button>
        <button @click="activeTab = 'operations'" 
          :class="activeTab === 'operations' ? 'bg-green-50 text-green-700 border-green-200' : 'text-gray-600 hover:bg-gray-50'"
          class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors border border-transparent">
          <i data-lucide="clipboard-list" class="w-5 h-5"></i>
          <span>Operazioni</span>
          <span class="ml-auto text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full" x-text="operations.length"></span>
        </button>
        <button @click="activeTab = 'seedlings'" 
          :class="activeTab === 'seedlings' ? 'bg-green-50 text-green-700 border-green-200' : 'text-gray-600 hover:bg-gray-50'"
          class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors border border-transparent">
          <i data-lucide="sprout" class="w-5 h-5"></i>
          <span>Piantine</span>
          <span class="ml-auto text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full" x-text="seedlingsAvailable.length"></span>
        </button>
      </nav>
      
      <!-- Quick Actions -->
      <div class="p-4 border-t bg-gray-50">
        <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Azioni Rapide</p>
        <div class="grid grid-cols-2 gap-2">
          <button @click="showOperationModal = true" class="flex flex-col items-center gap-1 p-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
            <i data-lucide="plus-circle" class="w-5 h-5"></i>
            <span class="text-xs font-medium">Operazione</span>
          </button>
          <button @click="showProductModal = true" class="flex flex-col items-center gap-1 p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            <i data-lucide="package-plus" class="w-5 h-5"></i>
            <span class="text-xs font-medium">Prodotto</span>
          </button>
          <button @click="showSupplierModal = true" class="flex flex-col items-center gap-1 p-3 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition-colors">
            <i data-lucide="truck" class="w-5 h-5"></i>
            <span class="text-xs font-medium">Fornitore</span>
          </button>
          <button @click="showPlotModal = true" class="flex flex-col items-center gap-1 p-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
            <i data-lucide="map-pin" class="w-5 h-5"></i>
            <span class="text-xs font-medium">Appezzam.</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- Mobile Header -->
    <header class="lg:hidden fixed top-0 left-0 right-0 bg-green-600 text-white shadow-lg z-40">
      <div class="flex items-center justify-between px-4 py-3">
        <div class="flex items-center gap-2">
          <i data-lucide="leaf" class="w-6 h-6"></i>
          <h1 class="font-bold">Gestionale Agricolo</h1>
        </div>
        <button @click="showQuickActions = !showQuickActions" class="p-2 hover:bg-green-700 rounded-lg">
          <i data-lucide="plus" class="w-6 h-6"></i>
        </button>
      </div>
      
      <!-- Mobile Quick Actions Dropdown -->
      <div x-show="showQuickActions" x-cloak @click.away="showQuickActions = false" 
           class="absolute top-full right-0 left-0 bg-white shadow-lg border-t p-4 grid grid-cols-4 gap-2">
        <button @click="showOperationModal = true; showQuickActions = false" class="flex flex-col items-center gap-1 p-2 text-green-600 hover:bg-green-50 rounded-lg">
          <i data-lucide="clipboard-list" class="w-6 h-6"></i>
          <span class="text-xs">Operazione</span>
        </button>
        <button @click="showProductModal = true; showQuickActions = false" class="flex flex-col items-center gap-1 p-2 text-blue-600 hover:bg-blue-50 rounded-lg">
          <i data-lucide="package-plus" class="w-6 h-6"></i>
          <span class="text-xs">Prodotto</span>
        </button>
        <button @click="showSupplierModal = true; showQuickActions = false" class="flex flex-col items-center gap-1 p-2 text-amber-600 hover:bg-amber-50 rounded-lg">
          <i data-lucide="truck" class="w-6 h-6"></i>
          <span class="text-xs">Fornitore</span>
        </button>
        <button @click="showPlotModal = true; showQuickActions = false" class="flex flex-col items-center gap-1 p-2 text-purple-600 hover:bg-purple-50 rounded-lg">
          <i data-lucide="map-pin" class="w-6 h-6"></i>
          <span class="text-xs">Appezzam.</span>
        </button>
      </div>
    </header>

    <!-- Bottom Navigation Mobile -->
    <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg z-40 safe-area-bottom">
      <div class="grid grid-cols-6 h-16">
        <button @click="activeTab = 'dashboard'" 
          :class="activeTab === 'dashboard' ? 'text-green-600' : 'text-gray-400'"
          class="flex flex-col items-center justify-center gap-0.5 hover:text-green-600 transition-colors">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
          <span class="text-[10px] font-medium">Home</span>
        </button>
        <button @click="activeTab = 'products'" 
          :class="activeTab === 'products' ? 'text-green-600' : 'text-gray-400'"
          class="flex flex-col items-center justify-center gap-0.5 hover:text-green-600 transition-colors">
          <i data-lucide="package" class="w-5 h-5"></i>
          <span class="text-[10px] font-medium">Prodotti</span>
        </button>
        <button @click="activeTab = 'batches'" 
          :class="activeTab === 'batches' ? 'text-green-600' : 'text-gray-400'"
          class="flex flex-col items-center justify-center gap-0.5 hover:text-green-600 transition-colors">
          <i data-lucide="layers" class="w-5 h-5"></i>
          <span class="text-[10px] font-medium">Lotti</span>
        </button>
        <button @click="activeTab = 'plots'" 
          :class="activeTab === 'plots' ? 'text-green-600' : 'text-gray-400'"
          class="flex flex-col items-center justify-center gap-0.5 hover:text-green-600 transition-colors">
          <i data-lucide="map-pin" class="w-5 h-5"></i>
          <span class="text-[10px] font-medium">Terreni</span>
        </button>
        <button @click="activeTab = 'operations'" 
          :class="activeTab === 'operations' ? 'text-green-600' : 'text-gray-400'"
          class="flex flex-col items-center justify-center gap-0.5 hover:text-green-600 transition-colors">
          <i data-lucide="clipboard-list" class="w-5 h-5"></i>
          <span class="text-[10px] font-medium">Lavori</span>
        </button>
        <button @click="activeTab = 'suppliers'" 
          :class="activeTab === 'suppliers' ? 'text-green-600' : 'text-gray-400'"
          class="flex flex-col items-center justify-center gap-0.5 hover:text-green-600 transition-colors">
          <i data-lucide="truck" class="w-5 h-5"></i>
          <span class="text-[10px] font-medium">Fornitori</span>
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 lg:ml-64 pt-14 pb-20 lg:pt-0 lg:pb-0">
      <div class="max-w-6xl mx-auto px-4 py-6">

      <!-- Loading -->
      <div x-show="loading" class="flex items-center justify-center py-20">
        <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-green-600"></i>
      </div>

      <!-- Dashboard -->
      <div x-show="activeTab === 'dashboard' && !loading" x-cloak>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-white rounded-xl shadow-sm border p-4">
            <div class="flex items-center gap-3">
              <div class="p-2 rounded-lg bg-blue-500">
                <i data-lucide="package" class="w-5 h-5 text-white"></i>
              </div>
              <div>
                <p class="text-sm text-gray-500">Prodotti</p>
                <p class="text-xl font-semibold" x-text="products.length"></p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border p-4">
            <div class="flex items-center gap-3">
              <div class="p-2 rounded-lg bg-green-500">
                <i data-lucide="leaf" class="w-5 h-5 text-white"></i>
              </div>
              <div>
                <p class="text-sm text-gray-500">Lotti in giacenza</p>
                <p class="text-xl font-semibold" x-text="batches.length"></p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border p-4">
            <div class="flex items-center gap-3">
              <div class="p-2 rounded-lg bg-amber-500">
                <i data-lucide="bar-chart-3" class="w-5 h-5 text-white"></i>
              </div>
              <div>
                <p class="text-sm text-gray-500">Raccolto (30gg)</p>
                <p class="text-xl font-semibold" x-text="(dashboard?.monthly_harvest_kg || 0) + ' kg'"></p>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border">
          <div class="p-4 border-b">
            <h2 class="font-semibold">Ultime Operazioni</h2>
          </div>
          <div class="divide-y">
            <template x-for="op in dashboard?.recent_operations || []" :key="op.id">
              <div class="p-4 flex items-center justify-between">
                <div>
                  <p class="font-medium" x-text="op.type_name"></p>
                  <p class="text-sm text-gray-500" x-text="op.plot_name || 'Nessun appezzamento'"></p>
                </div>
                <span class="text-sm text-gray-500" x-text="op.operation_date"></span>
              </div>
            </template>
            <div x-show="!dashboard?.recent_operations?.length" class="p-4 text-gray-500 text-center">
              Nessuna operazione registrata
            </div>
          </div>
        </div>
      </div>

      <!-- Prodotti -->
      <div x-show="activeTab === 'products' && !loading" x-cloak>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">Prodotti</h2>
          <button @click="showProductModal = true" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
            <i data-lucide="plus" class="w-4 h-4"></i> 
            <span class="hidden sm:inline">Nuovo Prodotto</span>
            <span class="sm:hidden">Nuovo</span>
          </button>
        </div>
        
        <!-- Mobile: Cards -->
        <div class="lg:hidden space-y-3">
          <template x-for="p in products" :key="p.id">
            <div @click="openEditProduct(p)" class="bg-white rounded-xl shadow-sm border p-4 cursor-pointer hover:border-green-300 hover:shadow-md transition-all">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold text-gray-900" x-text="p.name"></p>
                  <p class="text-sm text-green-600 font-mono" x-text="p.sku"></p>
                </div>
                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full" x-text="p.category_name"></span>
              </div>
              <p x-show="p.notes" class="text-sm text-gray-500 mt-2" x-text="p.notes"></p>
            </div>
          </template>
          <div x-show="!products.length" class="bg-white rounded-xl p-8 text-center text-gray-500">
            Nessun prodotto. Crea il primo!
          </div>
        </div>
        
        <!-- Desktop: Table -->
        <div class="hidden lg:block bg-white rounded-xl shadow-sm border overflow-hidden">
          <table class="w-full" x-show="products.length">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">SKU</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Nome</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Categoria</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Note</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Azioni</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-for="p in products" :key="p.id">
                <tr @click="openEditProduct(p)" class="hover:bg-green-50 cursor-pointer">
                  <td class="px-4 py-3 font-mono text-sm text-green-600" x-text="p.sku"></td>
                  <td class="px-4 py-3 font-medium" x-text="p.name"></td>
                  <td class="px-4 py-3">
                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full" x-text="p.category_name"></span>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-500" x-text="p.notes || '-'"></td>
                  <td class="px-4 py-3 text-center">
                    <button class="text-green-600 hover:text-green-800">
                      <i data-lucide="pencil" class="w-4 h-4"></i>
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
          <div x-show="!products.length" class="p-8 text-center text-gray-500">
            Nessun prodotto. Crea il primo!
          </div>
        </div>
      </div>

      <!-- Lotti -->
      <div x-show="activeTab === 'batches' && !loading" x-cloak>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">Lotti in Giacenza</h2>
          <button @click="showBatchModal = true" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
            <i data-lucide="plus" class="w-4 h-4"></i> 
            <span class="hidden sm:inline">Nuovo Acquisto</span>
            <span class="sm:hidden">Nuovo</span>
          </button>
        </div>
        
        <!-- Mobile: Cards -->
        <div class="lg:hidden space-y-3">
          <template x-for="b in batches" :key="b.id">
            <div class="bg-white rounded-xl shadow-sm border p-4">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <p class="font-semibold text-gray-900" x-text="b.product_name"></p>
                  <p class="text-sm text-gray-500 font-mono" x-text="b.sku"></p>
                </div>
                <div class="text-right">
                  <p class="text-lg font-bold text-green-600" x-text="b.current_qty + ' ' + (b.unit_name || '')"></p>
                  <p class="text-xs text-gray-400">disponibili</p>
                </div>
              </div>
              <div class="flex items-center justify-between text-sm text-gray-500 pt-2 border-t">
                <span class="font-mono" x-text="b.batch_code"></span>
                <span x-show="b.supplier_name" x-text="b.supplier_name"></span>
              </div>
            </div>
          </template>
          <div x-show="!batches.length" class="bg-white rounded-xl p-8 text-center text-gray-500">
            Nessun lotto in giacenza
          </div>
        </div>
        
        <!-- Desktop: Table -->
        <div class="hidden lg:block bg-white rounded-xl shadow-sm border overflow-hidden">
          <table class="w-full" x-show="batches.length">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Lotto</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Prodotto</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">SKU</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Fornitore</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Giacenza</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-for="b in batches" :key="b.id">
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3 font-mono text-sm text-green-600" x-text="b.batch_code"></td>
                  <td class="px-4 py-3 font-medium" x-text="b.product_name"></td>
                  <td class="px-4 py-3 text-gray-500 font-mono text-sm" x-text="b.sku"></td>
                  <td class="px-4 py-3 text-gray-500" x-text="b.supplier_name || '-'"></td>
                  <td class="px-4 py-3 text-right">
                    <span class="font-bold text-green-600" x-text="b.current_qty"></span>
                    <span class="text-gray-500" x-text="b.unit_name || ''"></span>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
          <div x-show="!batches.length" class="p-8 text-center text-gray-500">
            Nessun lotto in giacenza
          </div>
        </div>
      </div>

      <!-- Appezzamenti -->
      <div x-show="activeTab === 'plots' && !loading" x-cloak>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">Appezzamenti</h2>
          <button @click="showPlotModal = true" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
            <i data-lucide="plus" class="w-4 h-4"></i> Nuovo Appezzamento
          </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <template x-for="p in plots" :key="p.id">
            <div class="bg-white rounded-xl shadow-sm border p-4">
              <div class="flex items-start gap-3">
                <div class="p-2 bg-green-100 rounded-lg">
                  <i data-lucide="map-pin" class="w-5 h-5 text-green-600"></i>
                </div>
                <div>
                  <h3 class="font-semibold" x-text="p.name"></h3>
                  <p class="text-sm text-gray-500" x-text="'N¬∞ ' + p.code"></p>
                  <p x-show="p.area_sqm" class="text-sm text-gray-500" x-text="p.area_sqm + ' m¬≤'"></p>
                </div>
              </div>
            </div>
          </template>
        </div>
        <div x-show="!plots.length" class="bg-white rounded-xl shadow-sm border p-8 text-center text-gray-500">
          Nessun appezzamento. Crea il primo!
        </div>
      </div>

      <!-- Operazioni -->
      <div x-show="activeTab === 'operations' && !loading" x-cloak>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">Operazioni</h2>
          <button @click="showOperationModal = true" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
            <i data-lucide="plus" class="w-4 h-4"></i> Nuova Operazione
          </button>
        </div>
        <div class="bg-white rounded-xl shadow-sm border">
          <div class="divide-y">
            <template x-for="op in operations" :key="op.id">
              <div @click="openEditOperation(op)" class="p-4 hover:bg-green-50 cursor-pointer transition-colors">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-4">
                    <!-- Icona dinamica per tipo -->
                    <div class="p-2 rounded-lg" :class="{
                      'bg-green-100': op.type_code === 'semina',
                      'bg-blue-100': op.type_code === 'trapianto',
                      'bg-amber-100': op.type_code === 'concimazione' || op.type_code === 'trattamento',
                      'bg-orange-100': op.type_code === 'raccolta',
                      'bg-gray-100': !['semina','trapianto','concimazione','trattamento','raccolta'].includes(op.type_code)
                    }">
                      <i :data-lucide="op.type_code === 'semina' ? 'sprout' : 
                                       op.type_code === 'trapianto' ? 'move' :
                                       op.type_code === 'raccolta' ? 'apple' :
                                       op.type_code === 'concimazione' ? 'flask-conical' :
                                       op.type_code === 'trattamento' ? 'spray-can' : 'clipboard-list'" 
                         class="w-5 h-5" :class="{
                           'text-green-600': op.type_code === 'semina',
                           'text-blue-600': op.type_code === 'trapianto',
                           'text-amber-600': op.type_code === 'concimazione' || op.type_code === 'trattamento',
                           'text-orange-600': op.type_code === 'raccolta',
                           'text-gray-600': !['semina','trapianto','concimazione','trattamento','raccolta'].includes(op.type_code)
                         }"></i>
                    </div>
                    <div>
                      <p class="font-medium" x-text="op.type_name"></p>
                      
                      <!-- Dettagli specifici per SEMINA -->
                      <div x-show="op.type_code === 'semina'" class="text-sm text-gray-600">
                        <span x-show="op.product_name" class="text-green-700 font-medium" x-text="'üå± ' + op.product_name"></span>
                        <span x-show="op.quantity" class="text-gray-500"> ¬∑ <span x-text="op.quantity + ' ' + (op.unit_name || '')"></span> usati</span>
                        <span x-show="op.seedling_name" class="text-blue-600"> ‚Üí <span x-text="op.seedlings_produced"></span> piantine "<span x-text="op.seedling_name"></span>"</span>
                      </div>
                      
                      <!-- Dettagli specifici per TRAPIANTO -->
                      <div x-show="op.type_code === 'trapianto'" class="text-sm text-gray-600">
                        <span x-show="op.seedling_name" class="text-blue-700 font-medium" x-text="'üåø ' + op.seedling_name"></span>
                        <span x-show="op.quantity" class="text-gray-500"> ¬∑ <span x-text="op.quantity"></span> piantine</span>
                      </div>
                      
                      <!-- Dettagli specifici per CONCIMAZIONE/TRATTAMENTO -->
                      <div x-show="op.type_code === 'concimazione' || op.type_code === 'trattamento'" class="text-sm text-gray-600">
                        <span x-show="op.product_name" class="text-amber-700 font-medium" x-text="'üß™ ' + op.product_name"></span>
                        <span x-show="op.quantity" class="text-gray-500"> ¬∑ <span x-text="op.quantity + ' ' + (op.unit_name || '')"></span></span>
                      </div>
                      
                      <!-- Dettagli specifici per RACCOLTA -->
                      <div x-show="op.type_code === 'raccolta'" class="text-sm text-gray-600">
                        <span x-show="op.harvest_product" class="text-orange-700 font-medium" x-text="'üß∫ ' + op.harvest_product"></span>
                        <span x-show="op.harvest_kg" class="text-gray-500"> ¬∑ <span x-text="op.harvest_kg"></span> kg</span>
                      </div>
                      
                      <!-- Appezzamento e note (per tutti) -->
                      <p class="text-sm text-gray-400 mt-1">
                        <span x-text="op.plot_name || ''"></span>
                        <span x-show="op.plot_name && op.notes"> ¬∑ </span>
                        <span x-show="op.notes" x-text="op.notes"></span>
                      </p>
                    </div>
                  </div>
                  <div class="text-right flex items-center gap-3">
                    <span class="text-sm text-gray-500" x-text="new Date(op.operation_date).toLocaleDateString('it-IT')"></span>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                  </div>
                </div>
              </div>
            </template>
          </div>
          <div x-show="!operations.length" class="p-8 text-center text-gray-500">
            Nessuna operazione registrata
          </div>
        </div>
      </div>

      <!-- Fornitori -->
      <div x-show="activeTab === 'suppliers' && !loading" x-cloak>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">üöö Fornitori</h2>
          <button @click="showSupplierModal = true" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
            <i data-lucide="plus" class="w-4 h-4"></i> 
            <span class="hidden sm:inline">Nuovo Fornitore</span>
            <span class="sm:hidden">Nuovo</span>
          </button>
        </div>
        
        <!-- Mobile: Cards -->
        <div class="lg:hidden space-y-3">
          <template x-for="s in suppliers" :key="s.id">
            <div class="bg-white rounded-xl shadow-sm border p-4">
              <!-- Header con nome e codice -->
              <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center">
                    <i data-lucide="building-2" class="w-5 h-5 text-amber-600"></i>
                  </div>
                  <div>
                    <p class="font-semibold text-gray-900" x-text="s.name"></p>
                    <p class="text-xs text-green-600 font-mono" x-text="s.code"></p>
                  </div>
                </div>
              </div>
              
              <!-- Info -->
              <div class="space-y-2 text-sm">
                <!-- P.IVA -->
                <div x-show="s.vat_number" class="flex items-center gap-2 text-gray-600">
                  <i data-lucide="file-text" class="w-4 h-4 text-gray-400 flex-shrink-0"></i>
                  <span>P.IVA: <span class="font-mono" x-text="s.vat_number?.trim()"></span></span>
                </div>
                
                <!-- Indirizzo -->
                <div x-show="s.address || s.city" class="flex items-start gap-2 text-gray-600">
                  <i data-lucide="map-pin" class="w-4 h-4 text-gray-400 flex-shrink-0 mt-0.5"></i>
                  <span x-text="[s.address, s.zip_code, s.city, s.province ? '(' + s.province + ')' : ''].filter(Boolean).join(', ')"></span>
                </div>
                
                <!-- Telefono -->
                <div x-show="s.phone" class="flex items-center gap-2">
                  <i data-lucide="phone" class="w-4 h-4 text-gray-400 flex-shrink-0"></i>
                  <a :href="'tel:' + s.phone" class="text-green-600 font-medium" x-text="s.phone"></a>
                </div>
                
                <!-- Email -->
                <div x-show="s.email" class="flex items-center gap-2">
                  <i data-lucide="mail" class="w-4 h-4 text-gray-400 flex-shrink-0"></i>
                  <a :href="'mailto:' + s.email" class="text-green-600 font-medium" x-text="s.email"></a>
                </div>
                
                <!-- Note -->
                <div x-show="s.notes" class="pt-2 mt-2 border-t">
                  <p class="text-gray-500 italic text-xs" x-text="s.notes"></p>
                </div>
              </div>
            </div>
          </template>
          <div x-show="!suppliers.length" class="bg-white rounded-xl p-8 text-center text-gray-500">
            <i data-lucide="truck" class="w-12 h-12 mx-auto text-gray-300 mb-3"></i>
            <p>Nessun fornitore registrato</p>
            <p class="text-sm mt-1">Clicca su "Nuovo" per aggiungere il primo fornitore</p>
          </div>
        </div>
        
        <!-- Desktop: Table -->
        <div class="hidden lg:block bg-white rounded-xl shadow-sm border overflow-hidden">
          <table class="w-full" x-show="suppliers.length">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Codice</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Ragione Sociale</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">P.IVA</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Indirizzo</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Contatti</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-for="s in suppliers" :key="s.id">
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3">
                    <span class="font-mono text-sm text-green-600 bg-green-50 px-2 py-1 rounded" x-text="s.code"></span>
                  </td>
                  <td class="px-4 py-3">
                    <p class="font-medium text-gray-900" x-text="s.name"></p>
                    <p x-show="s.notes" class="text-xs text-gray-400 truncate max-w-xs mt-1" x-text="s.notes"></p>
                  </td>
                  <td class="px-4 py-3 text-gray-600 font-mono text-sm" x-text="s.vat_number?.trim() || '-'"></td>
                  <td class="px-4 py-3 text-gray-600 text-sm">
                    <template x-if="s.address || s.city">
                      <div>
                        <p x-show="s.address" x-text="s.address"></p>
                        <p x-text="[s.zip_code, s.city, s.province ? '(' + s.province + ')' : ''].filter(Boolean).join(' ')"></p>
                      </div>
                    </template>
                    <span x-show="!s.address && !s.city" class="text-gray-400">-</span>
                  </td>
                  <td class="px-4 py-3 text-sm">
                    <div class="flex flex-col gap-1">
                      <a x-show="s.phone" :href="'tel:' + s.phone" class="text-gray-600 hover:text-green-600 flex items-center gap-1.5">
                        <i data-lucide="phone" class="w-3.5 h-3.5"></i>
                        <span x-text="s.phone"></span>
                      </a>
                      <a x-show="s.email" :href="'mailto:' + s.email" class="text-gray-600 hover:text-green-600 flex items-center gap-1.5">
                        <i data-lucide="mail" class="w-3.5 h-3.5"></i>
                        <span x-text="s.email"></span>
                      </a>
                      <span x-show="!s.phone && !s.email" class="text-gray-400">-</span>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
          <div x-show="!suppliers.length" class="p-8 text-center text-gray-500">
            <i data-lucide="truck" class="w-12 h-12 mx-auto text-gray-300 mb-3"></i>
            <p>Nessun fornitore registrato</p>
            <p class="text-sm mt-1">Clicca su "Nuovo Fornitore" per iniziare</p>
          </div>
        </div>
      </div>

      <!-- Seedlings / Piantine -->
      <div x-show="activeTab === 'seedlings' && !loading" x-cloak>
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-gray-800">üå± Piantine Disponibili</h2>
        </div>
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
          <table class="min-w-full divide-y divide-gray-200" x-show="seedlingsAvailable.length">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Nome</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Origine</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Prodotte</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Disponibili</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Data</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <template x-for="s in seedlingsAvailable" :key="s.id">
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3 font-medium" x-text="s.name"></td>
                  <td class="px-4 py-3">
                    <span x-show="s.source === 'semina_alveolo'" class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs">
                      üå± Semina in alveolo
                    </span>
                    <span x-show="s.source === 'acquisto'" class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs">
                      üõí Acquistate
                    </span>
                  </td>
                  <td class="px-4 py-3 text-gray-600" x-text="s.produced_qty"></td>
                  <td class="px-4 py-3">
                    <span class="font-semibold" :class="s.available_qty > 0 ? 'text-green-600' : 'text-red-500'" x-text="s.available_qty"></span>
                  </td>
                  <td class="px-4 py-3 text-gray-500 text-sm" x-text="new Date(s.created_at).toLocaleDateString('it-IT')"></td>
                </tr>
              </template>
            </tbody>
          </table>
          <div x-show="!seedlingsAvailable.length" class="p-8 text-center text-gray-500">
            <p class="mb-2">Nessuna piantina disponibile.</p>
            <p class="text-sm">Le piantine si creano con una <strong>semina in alveolo</strong> o acquistando prodotti della categoria <strong>piantine</strong>.</p>
          </div>
        </div>
      </div>

      </div>
    </main>

    <!-- Modal: Nuovo Prodotto + Acquisto -->
    <div x-show="showProductModal" x-cloak 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 z-50 overflow-y-auto">
      <div class="min-h-full flex items-start justify-center p-4 pt-12 lg:pt-20 pb-20">
        <div x-show="showProductModal"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 translate-y-4"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 translate-y-4"
             class="bg-white rounded-xl w-full max-w-lg shadow-2xl" @click.away="showProductModal = false">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white rounded-t-xl z-10">
          <h2 class="text-lg font-semibold">Nuovo Prodotto + Acquisto</h2>
          <button @click="showProductModal = false" class="text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
        <form @submit.prevent="createProduct()" class="p-4">
          <div class="mb-3 p-3 bg-green-50 rounded-lg text-sm text-green-700">
            <i data-lucide="info" class="w-4 h-4 inline"></i>
            SKU e codice lotto generati automaticamente
          </div>
          
          <!-- SEZIONE PRODOTTO -->
          <div class="mb-4 pb-3 border-b">
            <h3 class="font-medium text-gray-700 mb-3">üì¶ Dati Prodotto</h3>
            <div class="grid grid-cols-2 gap-3">
              <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Categoria *</label>
                <select x-model="newProduct.category_id" required class="w-full px-3 py-2 border rounded-lg">
                  <option value="">Seleziona...</option>
                  <template x-for="c in categories" :key="c.id">
                    <option :value="c.id" x-text="c.name"></option>
                  </template>
                </select>
              </div>
              <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Nome Prodotto *</label>
                <input x-model="newProduct.name" type="text" placeholder="Es: Semi Pomodoro San Marzano" required class="w-full px-3 py-2 border rounded-lg">
              </div>
            </div>
          </div>
          
          <!-- SEZIONE FORNITORE -->
          <div class="mb-4 pb-3 border-b">
            <h3 class="font-medium text-gray-700 mb-3">üöö Fornitore</h3>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Fornitore *</label>
              <select x-model="newProduct.supplier_id" required class="w-full px-3 py-2 border rounded-lg">
                <option value="">Seleziona fornitore...</option>
                <template x-for="s in suppliers" :key="s.id">
                  <option :value="s.id" x-text="s.code + ' - ' + s.name"></option>
                </template>
              </select>
            </div>
          </div>
          
          <!-- SEZIONE DOCUMENTO -->
          <div class="mb-4 pb-3 border-b">
            <h3 class="font-medium text-gray-700 mb-3">üìÑ Documento Acquisto</h3>
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                <select x-model="newProduct.document_type" class="w-full px-3 py-2 border rounded-lg">
                  <option value="">-</option>
                  <option value="ddt">DDT</option>
                  <option value="fattura">Fattura</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Numero</label>
                <input x-model="newProduct.document_number" type="text" placeholder="N¬∞ doc" class="w-full px-3 py-2 border rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                <input x-model="newProduct.document_date" type="date" class="w-full px-3 py-2 border rounded-lg">
              </div>
            </div>
          </div>
          
          <!-- SEZIONE QUANTIT√Ä -->
          <div class="mb-4">
            <h3 class="font-medium text-gray-700 mb-3">üìä Quantit√† Acquistata</h3>
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Quantit√† *</label>
                <input x-model="newProduct.quantity" type="number" step="0.01" min="0.01" placeholder="10" required class="w-full px-3 py-2 border rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Formato *</label>
                <select x-model="newProduct.unit_id" required class="w-full px-3 py-2 border rounded-lg">
                  <option value="">Seleziona...</option>
                  <template x-for="u in units.filter(u => !u.code.includes('_hl'))" :key="u.id">
                    <option :value="u.id" x-text="u.name"></option>
                  </template>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Prezzo ‚Ç¨</label>
                <input x-model="newProduct.purchase_price" type="number" step="0.01" min="0" placeholder="0.00" class="w-full px-3 py-2 border rounded-lg">
              </div>
            </div>
          </div>
          
          <!-- Note -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
            <input x-model="newProduct.notes" type="text" placeholder="Note opzionali..." class="w-full px-3 py-2 border rounded-lg">
          </div>
          
          <button type="submit" :disabled="saving" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <span x-show="saving" class="animate-spin">‚è≥</span>
            <span x-text="saving ? 'Salvataggio...' : 'Salva Prodotto + Acquisto'"></span>
          </button>
        </form>
        </div>
      </div>
    </div>

    <!-- Modal: Nuovo Lotto -->
    <div x-show="showBatchModal" x-cloak 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 z-50 overflow-y-auto">
      <div class="min-h-full flex items-start justify-center p-4 pt-12 lg:pt-20 pb-20">
        <div x-show="showBatchModal"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 translate-y-4"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 translate-y-4"
             class="bg-white rounded-xl w-full max-w-lg shadow-2xl" @click.away="showBatchModal = false">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white rounded-t-xl">
          <h2 class="text-lg font-semibold">Registra Acquisto</h2>
          <button @click="showBatchModal = false" class="text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
        <form @submit.prevent="createBatch()" class="p-4">
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Codice Lotto</label>
            <input x-model="newBatch.batch_code" type="text" placeholder="ES: LOTTO-2024-001" required class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Prodotto</label>
            <select x-model="newBatch.product_id" required class="w-full px-3 py-2 border rounded-lg">
              <option value="">Seleziona...</option>
              <template x-for="p in products" :key="p.id">
                <option :value="p.id" x-text="p.sku + ' - ' + p.name"></option>
              </template>
            </select>
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Fornitore</label>
            <select x-model="newBatch.supplier_id" class="w-full px-3 py-2 border rounded-lg">
              <option value="">Seleziona...</option>
              <template x-for="s in suppliers" :key="s.id">
                <option :value="s.id" x-text="s.name"></option>
              </template>
            </select>
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Quantit√†</label>
            <input x-model="newBatch.initial_qty" type="number" step="0.01" required class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Unit√†</label>
            <select x-model="newBatch.unit_id" class="w-full px-3 py-2 border rounded-lg">
              <option value="">Seleziona...</option>
              <template x-for="u in units" :key="u.id">
                <option :value="u.id" x-text="u.name + ' (' + u.code + ')'"></option>
              </template>
            </select>
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Data Acquisto</label>
            <input x-model="newBatch.purchase_date" type="date" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Prezzo ‚Ç¨</label>
            <input x-model="newBatch.purchase_price" type="number" step="0.01" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <button type="submit" :disabled="saving" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <span x-show="saving" class="animate-spin">‚è≥</span>
            <span x-text="saving ? 'Salvataggio...' : 'Registra Acquisto'"></span>
          </button>
        </form>
        </div>
      </div>
    </div>

    <!-- Modal: Nuovo Appezzamento -->
    <div x-show="showPlotModal" x-cloak 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 z-50 overflow-y-auto">
      <div class="min-h-full flex items-start justify-center p-4 pt-12 lg:pt-20 pb-20">
        <div x-show="showPlotModal"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 translate-y-4"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 translate-y-4"
             class="bg-white rounded-xl w-full max-w-lg shadow-2xl" @click.away="showPlotModal = false">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white rounded-t-xl">
          <h2 class="text-lg font-semibold">Nuovo Appezzamento</h2>
          <button @click="showPlotModal = false" class="text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
        <form @submit.prevent="createPlot()" class="p-4">
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">N¬∞ Appezzamento</label>
            <input x-model="newPlot.code" type="text" placeholder="Es: 456" required class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
            <input x-model="newPlot.name" type="text" placeholder="Es: Serra Grande" required class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Superficie (m¬≤)</label>
            <input x-model="newPlot.area_sqm" type="number" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
            <input x-model="newPlot.notes" type="text" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <button type="submit" :disabled="saving" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <span x-show="saving" class="animate-spin">‚è≥</span>
            <span x-text="saving ? 'Salvataggio...' : 'Salva Appezzamento'"></span>
          </button>
        </form>
        </div>
      </div>
    </div>

    <!-- Modal: Nuovo Fornitore -->
    <div x-show="showSupplierModal" x-cloak 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 z-50 overflow-y-auto">
      <div class="min-h-full flex items-start justify-center p-4 pt-12 lg:pt-20 pb-20">
        <div x-show="showSupplierModal"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 translate-y-4"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 translate-y-4"
             class="bg-white rounded-xl w-full max-w-lg shadow-2xl" @click.away="showSupplierModal = false">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white rounded-t-xl">
          <h2 class="text-lg font-semibold">Nuovo Fornitore</h2>
          <button @click="showSupplierModal = false" class="text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
        <form @submit.prevent="createSupplier()" class="p-4">
          <div class="mb-3 p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
            <i data-lucide="info" class="w-4 h-4 inline"></i>
            Il codice fornitore verr√† generato automaticamente
          </div>
          
          <!-- Ragione Sociale -->
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Ragione Sociale *</label>
            <input x-model="newSupplier.name" type="text" placeholder="Es: Sementi Italia Srl" required class="w-full px-3 py-2 border rounded-lg">
          </div>
          
          <!-- P.IVA -->
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Partita IVA</label>
            <input x-model="newSupplier.vat_number" type="text" placeholder="Es: IT01234567890" maxlength="16" class="w-full px-3 py-2 border rounded-lg font-mono">
          </div>
          
          <!-- Indirizzo -->
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Indirizzo</label>
            <input x-model="newSupplier.address" type="text" placeholder="Via/Piazza, numero civico" class="w-full px-3 py-2 border rounded-lg">
          </div>
          
          <!-- Citt√†, Provincia, CAP -->
          <div class="grid grid-cols-5 gap-2 mb-3">
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Citt√†</label>
              <input x-model="newSupplier.city" type="text" placeholder="Citt√†" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div class="col-span-1">
              <label class="block text-sm font-medium text-gray-700 mb-1">Prov.</label>
              <input x-model="newSupplier.province" type="text" placeholder="MI" maxlength="2" class="w-full px-3 py-2 border rounded-lg uppercase">
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">CAP</label>
              <input x-model="newSupplier.zip_code" type="text" placeholder="20100" maxlength="5" class="w-full px-3 py-2 border rounded-lg">
            </div>
          </div>
          
          <!-- Telefono e Email -->
          <div class="grid grid-cols-2 gap-2 mb-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Telefono</label>
              <input x-model="newSupplier.phone" type="tel" placeholder="+39 02 1234567" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input x-model="newSupplier.email" type="email" placeholder="info@esempio.it" class="w-full px-3 py-2 border rounded-lg">
            </div>
          </div>
          
          <!-- Note -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
            <textarea x-model="newSupplier.notes" rows="2" placeholder="Note aggiuntive..." class="w-full px-3 py-2 border rounded-lg"></textarea>
          </div>
          
          <button type="submit" :disabled="saving" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <span x-show="saving" class="animate-spin">‚è≥</span>
            <span x-text="saving ? 'Salvataggio...' : 'Salva Fornitore'"></span>
          </button>
        </form>
        </div>
      </div>
    </div>

    <!-- Modal: Nuova Operazione -->
    <div x-show="showOperationModal" x-cloak 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 z-50 overflow-y-auto">
      <div class="min-h-full flex items-start justify-center p-4 pt-12 lg:pt-20 pb-20">
        <div x-show="showOperationModal"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 translate-y-4"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 translate-y-4"
             class="bg-white rounded-xl w-full max-w-lg shadow-2xl" @click.away="showOperationModal = false">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white rounded-t-xl z-10">
          <h2 class="text-lg font-semibold">Nuova Operazione</h2>
          <button @click="showOperationModal = false" class="text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
        <form @submit.prevent="createOperation()" class="p-4">
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Operazione *</label>
            <select x-model="newOperation.type_code" required class="w-full px-3 py-2 border rounded-lg">
              <option value="">Seleziona...</option>
              <template x-for="t in operationTypes" :key="t.id">
                <option :value="t.code" x-text="t.name"></option>
              </template>
            </select>
          </div>
          
          <!-- Se Semina: scegli alveolo o campo -->
          <div x-show="newOperation.type_code === 'semina'" class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Semina *</label>
            <div class="flex gap-4">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" x-model="newOperation.seed_location" value="alveolo" class="text-green-600">
                <span>In Alveolo</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" x-model="newOperation.seed_location" value="campo" class="text-green-600">
                <span>In Campo</span>
              </label>
            </div>
          </div>
          
          <!-- Se Semina in ALVEOLO: chiedi piantine prodotte -->
          <div x-show="newOperation.type_code === 'semina' && newOperation.seed_location === 'alveolo'" class="mb-3 p-3 bg-green-50 rounded-lg">
            <p class="text-sm font-medium text-green-800 mb-2">üå± Piantine da ottenere</p>
            <div class="mb-2">
              <label class="block text-sm text-gray-700 mb-1">Nome piantina</label>
              <input x-model="newOperation.seedling_name" type="text" placeholder="Es: Pomodoro San Marzano" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-sm text-gray-700 mb-1">Quante piantine prevedi?</label>
              <input x-model="newOperation.seedlings_produced" type="number" min="1" placeholder="Es: 100" class="w-full px-3 py-2 border rounded-lg">
            </div>
          </div>
          
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Data *</label>
            <input x-model="newOperation.operation_date" type="date" required class="w-full px-3 py-2 border rounded-lg">
          </div>
          
          <!-- Multi-select Appezzamenti -->
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Appezzamenti</label>
            <div class="border rounded-lg p-2 max-h-32 overflow-auto">
              <template x-for="p in plots" :key="p.id">
                <label class="flex items-center gap-2 py-1 cursor-pointer hover:bg-gray-50 px-2 rounded">
                  <input type="checkbox" :value="p.id" x-model="newOperation.plot_ids" class="text-green-600 rounded">
                  <span x-text="'N¬∞ ' + p.code + ' - ' + p.name"></span>
                </label>
              </template>
            </div>
          </div>
          
          <!-- Se NON √® raccolta: mostra materia prima -->
          <div x-show="newOperation.type_code && newOperation.type_code !== 'raccolta'">
            <hr class="my-4">
            
            <!-- Per concimazione e trattamento: dosaggio speciale -->
            <div x-show="newOperation.type_code === 'concimazione' || newOperation.type_code === 'trattamento'">
              <p class="text-sm font-medium text-gray-700 mb-2">üíß Trattamento / Concimazione</p>
              
              <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Prodotto</label>
                <select x-model="newOperation.product_id" class="w-full px-3 py-2 border rounded-lg">
                  <option value="">Seleziona...</option>
                  <template x-for="cat in categoriesWithProducts" :key="cat.name">
                    <optgroup :label="cat.name">
                      <template x-for="p in cat.products" :key="p.id">
                        <option :value="p.id" x-text="p.name + ' (' + p.total_stock + ' ' + (p.unit_name || '') + ')'"></option>
                      </template>
                    </optgroup>
                  </template>
                </select>
              </div>
              
              <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Dosaggio</label>
                  <input x-model="newOperation.dosage_per_hl" type="number" step="0.1" placeholder="Es: 500" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Unit√†</label>
                  <select x-model="newOperation.dosage_unit" class="w-full px-3 py-2 border rounded-lg">
                    <option value="ml_hl">ml/hl</option>
                    <option value="gr_hl">gr/hl</option>
                  </select>
                </div>
              </div>
              
              <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Litri acqua usati</label>
                <input x-model="newOperation.water_liters" type="number" step="1" placeholder="Es: 200" class="w-full px-3 py-2 border rounded-lg">
              </div>
              
              <!-- Preview calcolo -->
              <div x-show="newOperation.dosage_per_hl && newOperation.water_liters" class="mb-3 p-3 bg-blue-50 rounded-lg text-sm">
                <p class="font-medium text-blue-800">üìä Quantit√† effettiva:</p>
                <p class="text-blue-700">
                  (<span x-text="newOperation.dosage_per_hl"></span> / 1000) √ó <span x-text="newOperation.water_liters"></span> lt = 
                  <strong x-text="((newOperation.dosage_per_hl / 1000) * newOperation.water_liters).toFixed(1)"></strong>
                  <span x-text="newOperation.dosage_unit === 'ml_hl' ? 'ml' : 'gr'"></span>
                </p>
              </div>
            </div>
            
            <!-- Per semina, trapianto, potatura: quantit√† semplice -->
            <div x-show="newOperation.type_code !== 'concimazione' && newOperation.type_code !== 'trattamento'">
              
              <!-- Per TRAPIANTO: mostra piantine disponibili -->
              <div x-show="newOperation.type_code === 'trapianto'">
                <p class="text-sm font-medium text-gray-700 mb-2">üå± Piantine da trapiantare</p>
                <div class="mb-3">
                  <label class="block text-sm text-gray-700 mb-1">Seleziona piantine</label>
                  <select x-model="newOperation.seedling_id" class="w-full px-3 py-2 border rounded-lg">
                    <option value="">Seleziona...</option>
                    <template x-for="s in seedlingsAvailable" :key="s.id">
                      <option :value="s.id" x-text="s.name + ' (' + s.available_qty + ' disp.) - ' + (s.source === 'acquisto' ? 'üõí acquistate' : 'üå± da semina')"></option>
                    </template>
                  </select>
                  <p x-show="!seedlingsAvailable.length" class="text-sm text-orange-600 mt-1">
                    ‚ö†Ô∏è Nessuna piantina disponibile. Inserisci prima una semina in alveolo o acquista piantine.
                  </p>
                </div>
                <div class="mb-3">
                  <label class="block text-sm text-gray-700 mb-1">Quantit√† da trapiantare</label>
                  <input x-model="newOperation.transplant_qty" type="number" min="1" placeholder="Es: 50" class="w-full px-3 py-2 border rounded-lg">
                </div>
              </div>
              
              <!-- Per SEMINA e POTATURA: mostra prodotti con giacenza -->
              <div x-show="newOperation.type_code !== 'trapianto'">
                <p class="text-sm text-gray-500 mb-2">Materia prima utilizzata (opzionale)</p>
                <div class="mb-3">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Prodotto</label>
                  <select x-model="newOperation.product_id" class="w-full px-3 py-2 border rounded-lg">
                    <option value="">Seleziona...</option>
                    <template x-for="cat in categoriesWithProducts" :key="cat.name">
                      <optgroup :label="cat.name">
                        <template x-for="p in cat.products" :key="p.id">
                          <option :value="p.id" x-text="p.name + ' (' + p.total_stock + ' ' + (p.unit_name || '') + ')'"></option>
                        </template>
                      </optgroup>
                    </template>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Quantit√† utilizzata</label>
                  <input x-model="newOperation.quantity" type="number" step="0.01" class="w-full px-3 py-2 border rounded-lg">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Se √® raccolta: mostra prodotto, appezzamento e kg raccolti -->
          <div x-show="newOperation.type_code === 'raccolta'">
            <hr class="my-4">
            <p class="text-sm font-medium text-gray-700 mb-2">üß∫ Raccolta</p>
            
            <div class="mb-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">Prodotto raccolto *</label>
              <input x-model="newOperation.harvest_product" type="text" placeholder="Es: Fragole, Pomodori, Albicocche..." :required="newOperation.type_code === 'raccolta'" class="w-full px-3 py-2 border rounded-lg">
            </div>
            
            <div class="mb-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">Kg Raccolti *</label>
              <input x-model="newOperation.harvest_kg" type="number" step="0.1" min="0" placeholder="Es: 150" :required="newOperation.type_code === 'raccolta'" class="w-full px-3 py-2 border rounded-lg">
            </div>
          </div>
          
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
            <input x-model="newOperation.notes" type="text" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <button type="submit" :disabled="saving" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <span x-show="saving" class="animate-spin">‚è≥</span>
            <span x-text="saving ? 'Salvataggio...' : 'Registra Operazione'"></span>
          </button>
        </form>
        </div>
      </div>
    </div>

    <!-- Modal: Modifica Prodotto -->
    <div x-show="showEditProductModal" x-cloak 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 z-50 overflow-y-auto">
      <div class="min-h-full flex items-start justify-center p-4 pt-12 lg:pt-20 pb-20">
        <div x-show="showEditProductModal"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 translate-y-4"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 translate-y-4"
             class="bg-white rounded-xl w-full max-w-lg shadow-2xl" @click.away="showEditProductModal = false">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white rounded-t-xl z-10">
          <h2 class="text-lg font-semibold">Dettaglio Prodotto</h2>
          <button @click="showEditProductModal = false" class="text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
        <div class="p-4" x-show="editProduct">
          <!-- Info prodotto -->
          <div class="mb-4 p-3 bg-green-50 rounded-lg">
            <p class="text-sm text-green-700 font-mono" x-text="editProduct?.sku"></p>
          </div>
          
          <form @submit.prevent="updateProduct()">
            <div class="mb-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
              <input x-model="editProduct.name" type="text" required class="w-full px-3 py-2 border rounded-lg">
            </div>
            
            <div class="mb-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
              <select x-model="editProduct.category_id" class="w-full px-3 py-2 border rounded-lg">
                <template x-for="c in categories" :key="c.id">
                  <option :value="c.id" x-text="c.name"></option>
                </template>
              </select>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
              <textarea x-model="editProduct.notes" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
            </div>
            
            <div class="flex gap-2">
              <button type="submit" :disabled="saving" class="flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400">
                <span x-text="saving ? 'Salvataggio...' : 'Salva Modifiche'"></span>
              </button>
              <button type="button" @click="deleteProduct()" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
          </form>
        </div>
        </div>
      </div>
    </div>

    <!-- Modal: Modifica Operazione -->
    <div x-show="showEditOperationModal" x-cloak 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 z-50 overflow-y-auto">
      <div class="min-h-full flex items-start justify-center p-4 pt-12 lg:pt-20 pb-20">
        <div x-show="showEditOperationModal"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 translate-y-4"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 translate-y-4"
             class="bg-white rounded-xl w-full max-w-lg shadow-2xl" @click.away="showEditOperationModal = false">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white rounded-t-xl z-10">
          <h2 class="text-lg font-semibold">Dettaglio Operazione</h2>
          <button @click="showEditOperationModal = false" class="text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
        <div class="p-4" x-show="editOperation">
          <!-- Header con tipo e data -->
          <div class="mb-4 p-3 rounded-lg" :class="{
            'bg-green-50': editOperation?.type_code === 'semina',
            'bg-blue-50': editOperation?.type_code === 'trapianto',
            'bg-amber-50': editOperation?.type_code === 'concimazione' || editOperation?.type_code === 'trattamento',
            'bg-orange-50': editOperation?.type_code === 'raccolta',
            'bg-gray-50': !['semina','trapianto','concimazione','trattamento','raccolta'].includes(editOperation?.type_code)
          }">
            <p class="font-medium" :class="{
              'text-green-800': editOperation?.type_code === 'semina',
              'text-blue-800': editOperation?.type_code === 'trapianto',
              'text-amber-800': editOperation?.type_code === 'concimazione' || editOperation?.type_code === 'trattamento',
              'text-orange-800': editOperation?.type_code === 'raccolta',
              'text-gray-800': !['semina','trapianto','concimazione','trattamento','raccolta'].includes(editOperation?.type_code)
            }" x-text="editOperation?.type_name"></p>
            <p class="text-sm text-gray-600" x-text="editOperation?.operation_date ? new Date(editOperation.operation_date).toLocaleDateString('it-IT', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'}) : ''"></p>
          </div>
          
          <!-- Dettagli specifici per SEMINA -->
          <div x-show="editOperation?.type_code === 'semina' && editOperation?.product_name" class="mb-4 p-3 bg-green-50 rounded-lg border border-green-200">
            <p class="text-sm text-green-700 font-medium mb-1">üå± Prodotto seminato</p>
            <p class="text-green-900 font-semibold" x-text="editOperation?.product_name"></p>
            <p x-show="editOperation?.quantity" class="text-sm text-green-600 mt-1" x-text="editOperation?.quantity + ' ' + (editOperation?.unit_name || '') + ' utilizzati'"></p>
            <div x-show="editOperation?.seedling_name" class="mt-2 pt-2 border-t border-green-200">
              <p class="text-sm text-blue-700">‚Üí Piantine prodotte: <strong x-text="editOperation?.seedlings_produced"></strong> "<span x-text="editOperation?.seedling_name"></span>"</p>
            </div>
          </div>
          
          <!-- Dettagli specifici per TRAPIANTO -->
          <div x-show="editOperation?.type_code === 'trapianto' && editOperation?.seedling_name" class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
            <p class="text-sm text-blue-700 font-medium mb-1">üåø Piantine trapiantate</p>
            <p class="text-blue-900 font-semibold" x-text="editOperation?.seedling_name"></p>
            <p x-show="editOperation?.quantity" class="text-sm text-blue-600 mt-1" x-text="editOperation?.quantity + ' piantine'"></p>
          </div>
          
          <!-- Dettagli specifici per CONCIMAZIONE/TRATTAMENTO -->
          <div x-show="(editOperation?.type_code === 'concimazione' || editOperation?.type_code === 'trattamento') && editOperation?.product_name" class="mb-4 p-3 bg-amber-50 rounded-lg border border-amber-200">
            <p class="text-sm text-amber-700 font-medium mb-1">üß™ Prodotto utilizzato</p>
            <p class="text-amber-900 font-semibold" x-text="editOperation?.product_name"></p>
            <p x-show="editOperation?.quantity" class="text-sm text-amber-600 mt-1" x-text="editOperation?.quantity + ' ' + (editOperation?.unit_name || '')"></p>
          </div>
          
          <!-- Dettagli specifici per RACCOLTA -->
          <div x-show="editOperation?.type_code === 'raccolta' && editOperation?.harvest_product" class="mb-4 p-3 bg-orange-50 rounded-lg border border-orange-200">
            <p class="text-sm text-orange-700 font-medium mb-1">üß∫ Raccolto</p>
            <p class="text-orange-900 font-semibold" x-text="editOperation?.harvest_product"></p>
            <p x-show="editOperation?.harvest_kg" class="text-sm text-orange-600 mt-1" x-text="editOperation?.harvest_kg + ' kg'"></p>
          </div>
          
          <form @submit.prevent="updateOperation()">
            <div class="mb-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
              <input x-model="editOperation.operation_date" type="date" required class="w-full px-3 py-2 border rounded-lg">
            </div>
            
            <div class="mb-3" x-show="editOperation?.plot_name">
              <label class="block text-sm font-medium text-gray-700 mb-1">Appezzamento</label>
              <input type="text" :value="editOperation?.plot_name" disabled class="w-full px-3 py-2 border rounded-lg bg-gray-100">
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
              <textarea x-model="editOperation.notes" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
            </div>
            
            <div class="flex gap-2">
              <button type="submit" :disabled="saving" class="flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400">
                <span x-text="saving ? 'Salvataggio...' : 'Salva Modifiche'"></span>
              </button>
              <button type="button" @click="deleteOperation()" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
          </form>
        </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://gestionale-agricolo-api.aziendamalbosca.workers.dev';

    function app() {
      return {
        activeTab: 'dashboard',
        loading: true,
        
        // Data
        products: [],
        productsWithStock: [],
        seedlingsAvailable: [],
        batches: [],
        plots: [],
        operations: [],
        suppliers: [],
        categories: [],
        units: [],
        operationTypes: [],
        dashboard: null,

        // Modals
        showProductModal: false,
        showBatchModal: false,
        showPlotModal: false,
        showSupplierModal: false,
        showOperationModal: false,
        showQuickActions: false,
        showEditProductModal: false,
        showEditOperationModal: false,
        saving: false,

        // Edit data
        editProduct: null,
        editOperation: null,

        // Forms
        newProduct: { 
          name: '', category_id: '', notes: '',
          supplier_id: '', document_type: '', document_number: '', document_date: '',
          quantity: '', unit_id: '', purchase_price: ''
        },
        newBatch: { batch_code: '', product_id: '', supplier_id: '', initial_qty: '', unit_id: '', purchase_date: '', purchase_price: '' },
        newPlot: { code: '', name: '', area_sqm: '', notes: '' },
        newSupplier: { name: '', vat_number: '', address: '', city: '', province: '', zip_code: '', phone: '', email: '', notes: '' },
        newOperation: { type_code: '', operation_date: '', plot_ids: [], product_id: '', quantity: '', notes: '', seed_location: '', harvest_kg: '', harvest_product: '', dosage_per_hl: '', dosage_unit: 'ml_hl', water_liters: '', seedling_name: '', seedlings_produced: '', seedling_id: '', transplant_qty: '' },

        // Computed: prodotti raggruppati per categoria
        get productsByCategory() {
          const grouped = {};
          const catOrder = ['sementi', 'piantine', 'concimi', 'fitofarmaci', 'substrati'];
          
          // Initialize categories
          catOrder.forEach(cat => { grouped[cat] = []; });
          grouped['altro'] = [];
          
          // Group products
          this.productsWithStock.forEach(p => {
            const catName = (p.category_name || 'altro').toLowerCase();
            if (grouped[catName]) {
              grouped[catName].push(p);
            } else {
              grouped['altro'].push(p);
            }
          });
          
          return grouped;
        },

        // Computed: categorie con prodotti
        get categoriesWithProducts() {
          const catNames = {
            'sementi': 'üå± Sementi',
            'piantine': 'üåø Piantine', 
            'concimi': 'üß™ Concimi',
            'fitofarmaci': 'üíä Fitofarmaci',
            'substrati': 'ü™¥ Substrati',
            'altro': 'üì¶ Altro'
          };
          
          return Object.entries(this.productsByCategory)
            .filter(([cat, prods]) => prods.length > 0)
            .map(([cat, prods]) => ({
              name: catNames[cat] || cat,
              products: prods
            }));
        },

        tabs: [
          { id: 'dashboard', label: 'Dashboard', icon: 'bar-chart-3' },
          { id: 'products', label: 'Prodotti', icon: 'package' },
          { id: 'batches', label: 'Lotti', icon: 'leaf' },
          { id: 'plots', label: 'Appezzamenti', icon: 'map-pin' },
          { id: 'operations', label: 'Operazioni', icon: 'clipboard-list' },
          { id: 'suppliers', label: 'Fornitori', icon: 'truck' },
        ],

        async init() {
          await this.loadAll();
          lucide.createIcons();
          this.$watch('activeTab', () => setTimeout(() => lucide.createIcons(), 10));
        },

        async loadAll() {
          this.loading = true;
          try {
            const [products, productsWithStock, seedlingsAvailable, batches, plots, operations, suppliers, categories, units, operationTypes, dashboard] = await Promise.all([
              this.fetch('/api/products'),
              this.fetch('/api/products-with-stock'),
              this.fetch('/api/seedlings-available'),
              this.fetch('/api/batches?with_stock=true'),
              this.fetch('/api/plots'),
              this.fetch('/api/operations'),
              this.fetch('/api/suppliers'),
              this.fetch('/api/categories'),
              this.fetch('/api/units'),
              this.fetch('/api/operation-types'),
              this.fetch('/api/dashboard'),
            ]);
            this.products = products;
            this.productsWithStock = productsWithStock;
            this.seedlingsAvailable = seedlingsAvailable;
            this.batches = batches;
            this.plots = plots;
            this.operations = operations;
            this.suppliers = suppliers;
            this.categories = categories;
            this.units = units;
            this.operationTypes = operationTypes;
            this.dashboard = dashboard;
          } catch (e) {
            console.error(e);
          }
          this.loading = false;
        },

        async fetch(endpoint) {
          const res = await fetch(API_BASE + endpoint);
          return res.json();
        },

        async post(endpoint, data, method = 'POST') {
          const res = await fetch(API_BASE + endpoint, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          return res.json();
        },

        async createProduct() {
          if (this.saving) return;
          this.saving = true;
          try {
            await this.post('/api/products/with-purchase', this.newProduct);
            this.showProductModal = false;
            this.newProduct = { 
              name: '', category_id: '', notes: '',
              supplier_id: '', document_type: '', document_number: '', document_date: '',
              quantity: '', unit_id: '', purchase_price: ''
            };
            this.products = await this.fetch('/api/products');
            this.batches = await this.fetch('/api/batches?with_stock=true');
            this.dashboard = await this.fetch('/api/dashboard');
          } finally {
            this.saving = false;
          }
        },

        async createBatch() {
          if (this.saving) return;
          this.saving = true;
          try {
            await this.post('/api/batches', { ...this.newBatch, source_type: 'purchase' });
            this.showBatchModal = false;
            this.newBatch = { batch_code: '', product_id: '', supplier_id: '', initial_qty: '', unit_id: '', purchase_date: '', purchase_price: '' };
            this.batches = await this.fetch('/api/batches?with_stock=true');
          } finally {
            this.saving = false;
          }
        },

        async createPlot() {
          if (this.saving) return;
          this.saving = true;
          try {
            await this.post('/api/plots', this.newPlot);
            this.showPlotModal = false;
            this.newPlot = { code: '', name: '', area_sqm: '', notes: '' };
            this.plots = await this.fetch('/api/plots');
          } finally {
            this.saving = false;
          }
        },

        async createSupplier() {
          if (this.saving) return;
          this.saving = true;
          try {
            await this.post('/api/suppliers', this.newSupplier);
            this.showSupplierModal = false;
            this.newSupplier = { name: '', vat_number: '', address: '', city: '', province: '', zip_code: '', phone: '', email: '', notes: '' };
            this.suppliers = await this.fetch('/api/suppliers');
          } finally {
            this.saving = false;
          }
        },

        async createOperation() {
          if (this.saving) return;
          this.saving = true;
          try {
            const data = {
              type_code: this.newOperation.type_code,
              operation_date: this.newOperation.operation_date,
              plot_ids: this.newOperation.plot_ids,
              notes: this.newOperation.notes,
              seed_location: this.newOperation.seed_location || null,
              harvest_kg: this.newOperation.harvest_kg ? parseFloat(this.newOperation.harvest_kg) : null,
              harvest_product: this.newOperation.harvest_product || null,
              water_liters: this.newOperation.water_liters ? parseFloat(this.newOperation.water_liters) : null,
              dosage_per_hl: this.newOperation.dosage_per_hl ? parseFloat(this.newOperation.dosage_per_hl) : null,
              dosage_unit: this.newOperation.dosage_unit || null,
              // Campi per semina in alveolo
              seedling_name: this.newOperation.seedling_name || null,
              seedlings_produced: this.newOperation.seedlings_produced ? parseInt(this.newOperation.seedlings_produced) : null,
              // Campi per trapianto
              seedling_id: this.newOperation.seedling_id ? parseInt(this.newOperation.seedling_id) : null,
              transplant_qty: this.newOperation.transplant_qty ? parseInt(this.newOperation.transplant_qty) : null,
              movements: []
            };
            
            // Se c'√® un prodotto selezionato (per semina/potatura), trova il batch e aggiungi il movimento
            if (this.newOperation.product_id && this.newOperation.type_code !== 'trapianto') {
              const product = this.productsWithStock.find(p => p.id == this.newOperation.product_id);
              if (product && product.first_batch_id) {
                // Per concimazione/trattamento la quantit√† viene calcolata dal backend
                // Per altri tipi usa la quantit√† inserita
                const qty = (this.newOperation.type_code === 'concimazione' || this.newOperation.type_code === 'trattamento')
                  ? 0  // il backend calcoler√† la quantit√† effettiva
                  : parseFloat(this.newOperation.quantity) || 0;
                  
                if (qty > 0 || this.newOperation.type_code === 'concimazione' || this.newOperation.type_code === 'trattamento') {
                  data.movements.push({
                    batch_id: product.first_batch_id,
                    movement_type: 'input',
                    quantity: qty
                  });
                }
              }
            }
            
            await this.post('/api/operations', data);
            this.showOperationModal = false;
            this.newOperation = { type_code: '', operation_date: '', plot_ids: [], product_id: '', quantity: '', notes: '', seed_location: '', harvest_kg: '', harvest_product: '', dosage_per_hl: '', dosage_unit: 'ml_hl', water_liters: '', seedling_name: '', seedlings_produced: '', seedling_id: '', transplant_qty: '' };
            this.operations = await this.fetch('/api/operations');
            this.batches = await this.fetch('/api/batches?with_stock=true');
            this.productsWithStock = await this.fetch('/api/products-with-stock');
            this.seedlingsAvailable = await this.fetch('/api/seedlings-available');
            this.dashboard = await this.fetch('/api/dashboard');
          } finally {
            this.saving = false;
          }
        },

        // Edit Product
        openEditProduct(product) {
          this.editProduct = { ...product };
          this.showEditProductModal = true;
          this.$nextTick(() => lucide.createIcons());
        },

        async updateProduct() {
          if (!this.editProduct) return;
          this.saving = true;
          try {
            await this.post(`/api/products/${this.editProduct.id}`, {
              name: this.editProduct.name,
              category_id: this.editProduct.category_id,
              notes: this.editProduct.notes
            }, 'PUT');
            this.showEditProductModal = false;
            this.products = await this.fetch('/api/products');
            this.productsWithStock = await this.fetch('/api/products-with-stock');
          } finally {
            this.saving = false;
          }
        },

        async deleteProduct() {
          if (!this.editProduct) return;
          if (!confirm(`Eliminare "${this.editProduct.name}"?\n\nAttenzione: verranno eliminati anche tutti i lotti associati.`)) return;
          
          this.saving = true;
          try {
            await this.post(`/api/products/${this.editProduct.id}`, {}, 'DELETE');
            this.showEditProductModal = false;
            this.products = await this.fetch('/api/products');
            this.productsWithStock = await this.fetch('/api/products-with-stock');
            this.batches = await this.fetch('/api/batches?with_stock=true');
          } finally {
            this.saving = false;
          }
        },

        // Edit Operation
        openEditOperation(operation) {
          this.editOperation = { ...operation };
          this.showEditOperationModal = true;
          this.$nextTick(() => lucide.createIcons());
        },

        async updateOperation() {
          if (!this.editOperation) return;
          this.saving = true;
          try {
            await this.post(`/api/operations/${this.editOperation.id}`, {
              operation_date: this.editOperation.operation_date,
              quantity: this.editOperation.quantity,
              notes: this.editOperation.notes
            }, 'PUT');
            this.showEditOperationModal = false;
            this.operations = await this.fetch('/api/operations');
          } finally {
            this.saving = false;
          }
        },

        async deleteOperation() {
          if (!this.editOperation) return;
          if (!confirm(`Eliminare questa operazione "${this.editOperation.type_name}" del ${new Date(this.editOperation.operation_date).toLocaleDateString('it-IT')}?`)) return;
          
          this.saving = true;
          try {
            await this.post(`/api/operations/${this.editOperation.id}`, {}, 'DELETE');
            this.showEditOperationModal = false;
            this.operations = await this.fetch('/api/operations');
            this.batches = await this.fetch('/api/batches?with_stock=true');
            this.productsWithStock = await this.fetch('/api/products-with-stock');
            this.dashboard = await this.fetch('/api/dashboard');
          } finally {
            this.saving = false;
          }
        }
      }
    }
  </script>

  <!-- PWA Install Banner -->
  <div id="installBanner" class="install-banner" style="display: none;">
    <div class="flex items-center gap-3">
      <span class="text-2xl">üå±</span>
      <div>
        <p class="font-semibold">Installa l'App</p>
        <p class="text-sm text-green-100">Accesso rapido dal tuo dispositivo</p>
      </div>
    </div>
    <div class="flex gap-2">
      <button onclick="dismissInstall()" class="px-3 py-1 text-green-100 hover:text-white">
        Dopo
      </button>
      <button onclick="installApp()" class="px-4 py-2 bg-white text-green-600 rounded-lg font-semibold hover:bg-green-50">
        Installa
      </button>
    </div>
  </div>

  <script>
    // PWA Installation
    let deferredPrompt;
    const installBanner = document.getElementById('installBanner');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Show install banner after 3 seconds
      setTimeout(() => {
        if (!localStorage.getItem('pwaInstallDismissed')) {
          installBanner.style.display = 'flex';
        }
      }, 3000);
    });

    function installApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('PWA installed');
          }
          deferredPrompt = null;
          installBanner.style.display = 'none';
        });
      }
    }

    function dismissInstall() {
      installBanner.style.display = 'none';
      localStorage.setItem('pwaInstallDismissed', 'true');
      // Reset after 7 days
      setTimeout(() => {
        localStorage.removeItem('pwaInstallDismissed');
      }, 7 * 24 * 60 * 60 * 1000);
    }

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('SW registered:', registration.scope);
          })
          .catch((error) => {
            console.log('SW registration failed:', error);
          });
      });
    }

    // Handle app installed event
    window.addEventListener('appinstalled', () => {
      installBanner.style.display = 'none';
      console.log('PWA was installed');
    });
  </script>
</body>
</html>
